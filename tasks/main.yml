---
- fail: msg="Please ensure '{{ item }}' is set"
  when:
    - not {{ item }} is defined or {{ item }} == ""
  with_items:
    - deploy_dir

- name: Install pm2 package
  npm:  name=pm2 global=yes version="{{ pm2_version | default(omit) }}"
  become: true

- name: Ensure pm2 is not running
  command: pm2 kill
  become: false

- name: Remove stuff from .pm2 directory
  file: path=/home/{{ ansible_user }}/.pm2/{{ item }} state=absent
  become: false
  with_items:
    - dump.pm2
    - pm2.log
    - pm2.pid
    - touch

- name: Install pm2-logrotate
  shell:  pm2 install pm2-logrotate
  become: false
  args:
    chdir: "{{ deploy_dir }}"

- name: Start PM2 using ecosystem.yml
  shell: pm2 start ecosystem.yml
  become: false
  args:
    chdir: "{{ deploy_dir }}"

- name: Set PM2 to start on reboot
  shell: pm2 startup linux -u {{ ansible_user }} --hp /home/{{ ansible_user }}
  become: true

- name: Save PM2
#  shell: pm2 save -u {{ ansible_user }} --hp /home/{{ ansible_user }}
  shell: pm2 save
  become: false


#sudo su -c ""
# sudo update-rc.d -f pm2-init.sh remove
# sudo rm /etc/init.d/pm2-init.sh
# sudo pkill -f PM2
# ps aux | grep pm2

# PM2_HOME=/home/{{ ansible_user }}/.pm2

